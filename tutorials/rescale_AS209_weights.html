

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities &#8212; visread 0.1.dev1+gfc94e7b documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/rescale_AS209_weights';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Casatools API" href="../casatools-api.html" />
    <link rel="prev" title="Introduction to CASA tools" href="introduction_to_casatools.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">visread 0.1.dev1+gfc94e7b documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="introduction_to_casatools.html">Introduction to CASA tools</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../casatools-api.html">Casatools API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Visread Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Visread API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-casa-dep.html">Visread + casatools API</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/MPoL-dev/visread" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tutorials/rescale_AS209_weights.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#obtaining-and-cleaning-the-as-209-measurement-set">Obtaining and CLEANing the AS 209 measurement set</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-visibilities-and-model-data">Model Visibilities and MODEL_DATA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-cleaned-image">Visualizing the CLEANed image</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-measurement-set-structure">Examining measurement set structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-tclean-model-to-calculate-residual-visibilities">Using the tclean model to calculate residual visibilities</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions-for-examining-weight-scatter">Helper functions for examining weight scatter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-scatter-for-each-spectral-window">Checking scatter for each spectral window</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-window-7-a-correctly-scaled-spw">Spectral Window 7: A correctly scaled SPW</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-window-22-visibility-outliers">Spectral Window 22: Visibility outliers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rescaling-weights-for-export">Rescaling weights for export.</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">run</span> notebook_setup
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="walkthrough-examining-dsharp-as-209-weights-and-exporting-visibilities">
<h1>Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities<a class="headerlink" href="#walkthrough-examining-dsharp-as-209-weights-and-exporting-visibilities" title="Permalink to this heading">#</a></h1>
<p>In this walkthrough tutorial, we’ll use CASA tools to examine the visibilities, visibility residuals, and weights of a real multi-configuration dataset from the DSHARP survey.</p>
<section id="obtaining-and-cleaning-the-as-209-measurement-set">
<h2>Obtaining and CLEANing the AS 209 measurement set<a class="headerlink" href="#obtaining-and-cleaning-the-as-209-measurement-set" title="Permalink to this heading">#</a></h2>
<p>The calibrated measurement sets from the DSHARP data release are available <a class="reference external" href="https://almascience.eso.org/almadata/lp/DSHARP/">online</a>, and the full description of the survey is provided in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..41A/abstract">Andrews et al. 2018</a>.</p>
<section id="model-visibilities-and-model-data">
<h3>Model Visibilities and MODEL_DATA<a class="headerlink" href="#model-visibilities-and-model-data" title="Permalink to this heading">#</a></h3>
<p>In its simplest form, the measurement set just contains the visibility data in a <code class="docutils literal notranslate"><span class="pre">DATA</span></code> or <code class="docutils literal notranslate"><span class="pre">CORRECTED_DATA</span></code> column. In the process of using <code class="docutils literal notranslate"><span class="pre">tclean</span></code> to synthesize an image, however, CASA also calculates a set of model visibilities that correspond to the Fourier transform of the CLEAN model. It’s possible to store these model visibilities to the measurement set if the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> process was invoked with the <code class="docutils literal notranslate"><span class="pre">savemodel=&quot;modelcolumn&quot;</span></code> parameter. The model visibilities will be stored in a <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column with the same shape as the <code class="docutils literal notranslate"><span class="pre">DATA</span></code> column.</p>
<p>The calibrated DSHARP measurement sets available from the archive do not contain this <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column (most likely for space reasons), so we will need to recreate them by running the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> algorithm with the relevant settings. The full reduction scripts are <a class="reference external" href="https://almascience.eso.org/almadata/lp/DSHARP/scripts/AS209_continuum.py">available online</a>, but we just need reproduce the relevant <code class="docutils literal notranslate"><span class="pre">tclean</span></code> commands used to produce a FITS image from the final, calibrated measurement set.</p>
<p>Because the measurement set is large (0.9 Gb) and the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> process is computationally expensive (taking about 1 hr on a single core), we have pre-executed those commands and cached the measurement set and <code class="docutils literal notranslate"><span class="pre">tclean</span></code> products into the <code class="docutils literal notranslate"><span class="pre">AS209_MS</span></code> local directory. If you’re interested in the exact <code class="docutils literal notranslate"><span class="pre">tclean</span></code> commands used, please check out the <a class="reference download internal" download="" href="../_downloads/c7dd1c1b360aefbae562788776b2e7e5/dl_and_tclean_AS209.py"><span class="xref download myst">dl_and_tclean_AS209.py</span></a> script directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># change to the cached subdirectory that contains the cleaned MS</span>
<span class="n">workdir</span> <span class="o">=</span> <span class="s2">&quot;AS209_MS&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;AS209_continuum.ms&quot;</span>
<span class="n">fitsname</span> <span class="o">=</span> <span class="s2">&quot;AS209.fits&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-the-cleaned-image">
<span id="as209-label"></span><h3>Visualizing the CLEANed image<a class="headerlink" href="#visualizing-the-cleaned-image" title="Permalink to this heading">#</a></h3>
<p>Just to make sure the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> process ran OK, let’s check the synthesized image that was produced</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsname</span><span class="p">)</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">data</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># mJy/pixel</span>
<span class="c1"># get the coordinate labels</span>
<span class="n">nx</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span>
<span class="n">ny</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span>
<span class="c1"># RA coordinates</span>
<span class="n">CDELT1</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span>  <span class="c1"># arcsec (converted from decimal deg)</span>
<span class="n">CRPIX1</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>  <span class="c1"># Now indexed from 0</span>
<span class="c1"># DEC coordinates</span>
<span class="n">CDELT2</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span>  <span class="c1"># arcsec</span>
<span class="n">CRPIX2</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>  <span class="c1"># Now indexed from 0</span>
<span class="n">RA</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="n">nx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">CDELT1</span>  <span class="c1"># [arcsec]</span>
<span class="n">DEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">-</span> <span class="n">ny</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">CDELT2</span>  <span class="c1"># [arcsec]</span>
<span class="c1"># extent needs to include extra half-pixels.</span>
<span class="c1"># RA, DEC are pixel centers</span>
<span class="n">ext</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">RA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">CDELT1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">RA</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">CDELT1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">DEC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">CDELT2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">DEC</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">CDELT2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># [arcsec]</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">animated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;mJy / pixel&quot;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">2.2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta \alpha \cos \delta$ [$</span><span class="si">{}</span><span class="s2">^{\prime\prime}$]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta \delta$ [$</span><span class="si">{}</span><span class="s2">^{\prime\prime}$]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$\\Delta \\delta$ [${}^{\\prime\\prime}$]&#39;)
</pre></div>
</div>
<img alt="../_images/04ff6412041cce6113bde0ce7693963ec1e2450f841bbf7fca274ba7244d6204.png" src="../_images/04ff6412041cce6113bde0ce7693963ec1e2450f841bbf7fca274ba7244d6204.png" />
</div>
</div>
<p>Great, it looks like things check out. Note that the main reason (at least for this tutorial) that we ran <code class="docutils literal notranslate"><span class="pre">tclean</span></code> was to generate the <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column in the measurement set. The actual CLEANed FITS image is just a nice byproduct.</p>
</section>
</section>
<section id="examining-measurement-set-structure">
<h2>Examining measurement set structure<a class="headerlink" href="#examining-measurement-set-structure" title="Permalink to this heading">#</a></h2>
<p>Before you dive into the full analysis with CASA tools, it’s a very good idea to inspect the measurement set using <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-task-list/task_listobs/about">listobs</a>.</p>
<p>After you’ve done that, let’s start exploring the visibility values. First we’ll need to import and then instantiate the relevant CASA tools, <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-tool-list/tool_table/methods">table</a> and <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-tool-list/tool_ms/methods">ms</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">casatools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tb</span> <span class="o">=</span> <span class="n">casatools</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">casatools</span><span class="o">.</span><span class="n">ms</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the indexes of the unique spectral windows, which are typically indexed by the <code class="docutils literal notranslate"><span class="pre">DATA_DESC_ID</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;/DATA_DESCRIPTION&quot;</span><span class="p">)</span>
<span class="n">SPECTRAL_WINDOW_ID</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;SPECTRAL_WINDOW_ID&quot;</span><span class="p">)</span>
<span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">SPECTRAL_WINDOW_ID</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
 24]
</pre></div>
</div>
</div>
</div>
<p>We see that there are 25 separate spectral windows! This is because the DSHARP images were produced using all available Band 6 continuum data on each source—not just the long baseline observations acquired in ALMA cycle 4. The merging of all of these individual observations is what creates this structure with so many spectral windows.</p>
<p>Next, let’s open the main table of the measurement set and inspect the column names</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="n">colnames</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">()</span>
<span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;UVW&#39;, &#39;FLAG&#39;, &#39;FLAG_CATEGORY&#39;, &#39;WEIGHT&#39;, &#39;SIGMA&#39;, &#39;ANTENNA1&#39;, &#39;ANTENNA2&#39;, &#39;ARRAY_ID&#39;, &#39;DATA_DESC_ID&#39;, &#39;EXPOSURE&#39;, &#39;FEED1&#39;, &#39;FEED2&#39;, &#39;FIELD_ID&#39;, &#39;FLAG_ROW&#39;, &#39;INTERVAL&#39;, &#39;OBSERVATION_ID&#39;, &#39;PROCESSOR_ID&#39;, &#39;SCAN_NUMBER&#39;, &#39;STATE_ID&#39;, &#39;TIME&#39;, &#39;TIME_CENTROID&#39;, &#39;DATA&#39;, &#39;WEIGHT_SPECTRUM&#39;, &#39;SIGMA_SPECTRUM&#39;, &#39;MODEL_DATA&#39;]
</pre></div>
</div>
</div>
</div>
<p>Because there are multiple spectral windows which do not share the same dimensions, we cannot use the <code class="docutils literal notranslate"><span class="pre">tb</span></code> tool to read the data directly. If we try, we’ll get an error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;WEIGHT&quot;</span><span class="p">)</span>  <span class="c1"># array of float64 with shape [npol, nvis]</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;FLAG&quot;</span><span class="p">)</span>  <span class="c1"># array of bool with shape [npol, nchan, nvis]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;DATA&quot;</span><span class="p">)</span>  <span class="c1"># array of complex128 with shape [npol, nchan, nvis]</span>
<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;We can&#39;t use table tools here... the spws have different numbers of channels&quot;</span>
    <span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>So, we’ll need to use the <code class="docutils literal notranslate"><span class="pre">ms</span></code> tool to read the visibilities for each spectral window, like so</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="c1"># select the spectral window</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">datadescid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># query the desired columnames as a list</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s2">&quot;WEIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;UVW&quot;</span><span class="p">,</span> <span class="s2">&quot;DATA&quot;</span><span class="p">])</span>
<span class="c1"># always a good idea to reset the earmarked data</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>The returned query is a dictionary whose keys are the lowercase column names</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;data&#39;, &#39;uvw&#39;, &#39;weight&#39;])
</pre></div>
</div>
</div>
</div>
<p>and whose values are the numerical arrays for the spectral window that we queried</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[[-0.09359986-0.07905877j  0.19716288+0.10789031j
   -0.04736413-0.38649508j ...  0.4015328 +0.23623116j
    0.20422684+0.29638007j  0.13025568-0.55658323j]]

 [[ 0.43320566-0.16495545j -0.0630829 -0.10485866j
   -0.36411372-0.40655291j ...  0.24039683-0.32688245j
    0.46174076-0.27798796j  0.61960417+0.00973242j]]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-the-tclean-model-to-calculate-residual-visibilities">
<h2>Using the tclean model to calculate residual visibilities<a class="headerlink" href="#using-the-tclean-model-to-calculate-residual-visibilities" title="Permalink to this heading">#</a></h2>
<p>In any data analysis where you’re computing a forward model, it’s a good consitency check to examine the data residuals from that model, and, in particular, whether their scatter matches the expectations from the noise properties.</p>
<p>We can calculate data residuals using the model visibilities derived from the tclean model and stored in the <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column of the measurement set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="c1"># select the spectral window</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">datadescid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># query the desired columnames as a list</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s2">&quot;MODEL_DATA&quot;</span><span class="p">])</span>
<span class="c1"># always a good idea to reset the earmarked data</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="s2">&quot;model_data&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[[0.05803835-0.00023424j 0.06033794-0.00052241j 0.0323186 -0.00052189j
   ... 0.059181  -0.0004049j  0.06829856-0.00039429j
   0.19727643-0.00036472j]]

 [[0.05803835-0.00023424j 0.06033794-0.00052241j 0.0323186 -0.00052189j
   ... 0.059181  -0.0004049j  0.06829856-0.00039429j
   0.19727643-0.00036472j]]]
</pre></div>
</div>
</div>
</div>
<p>Using these model visibilities, let’s calculate the residuals for each polarization (XX, YY) in units of <span class="math notranslate nohighlight">\(\sigma\)</span>, where</p>
<div class="math notranslate nohighlight">
\[
\sigma = \mathrm{sigma\_rescale} \times \sigma_0
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\sigma_0 = \sqrt{1/w}
\]</div>
<p>The scatter is defined as</p>
<div class="math notranslate nohighlight">
\[
\mathrm{scatter} = \frac{\mathrm{DATA} - \mathrm{MODEL\_DATA}}{\sigma}
\]</div>
<p>For now, <span class="math notranslate nohighlight">\(\mathrm{sigma\_rescale} = 1\)</span>, but we’ll see why this parameter is needed in a moment.</p>
<section id="helper-functions-for-examining-weight-scatter">
<h3>Helper functions for examining weight scatter<a class="headerlink" href="#helper-functions-for-examining-weight-scatter" title="Permalink to this heading">#</a></h3>
<p>Because we’d like to repeat this analysis for each spectral window in the measurement set, it makes things easier if we write these calculations as functions.</p>
<p>The functions provided in this document are only dependent on the CASA tools <code class="docutils literal notranslate"><span class="pre">tb</span></code> and <code class="docutils literal notranslate"><span class="pre">ms</span></code>. If you find yourself using these routines frequently, you might consider installing the <em>visread</em> package, since similar commands are provided in the API.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scatter_datadescid</span><span class="p">(</span><span class="n">datadescid</span><span class="p">,</span> <span class="n">sigma_rescale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the scatter for each polarization.</span>

<span class="sd">    Args:</span>
<span class="sd">        datadescid (int): the DATA_DESC_ID to be queried</span>
<span class="sd">        sigma_rescale (int):  multiply the uncertainties by this factor</span>
<span class="sd">        apply_flags (bool): calculate the scatter *after* the flags have been applied</span>

<span class="sd">    Returns:</span>
<span class="sd">        scatter_XX, scatter_YY: a 2-tuple of numpy arrays containing the scatter in each polarization.</span>
<span class="sd">        If ``apply_flags==True``, each array will be 1-dimensional. If ``apply_flags==False``, each array</span>
<span class="sd">        will retain its original shape, including channelization (e.g., shape ``nchan,nvis``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="c1"># select the key</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">datadescid</span><span class="o">=</span><span class="n">datadescid</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;MODEL_DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;WEIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;UVW&quot;</span><span class="p">,</span> <span class="s2">&quot;ANTENNA1&quot;</span><span class="p">,</span> <span class="s2">&quot;ANTENNA2&quot;</span><span class="p">,</span> <span class="s2">&quot;FLAG&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">data</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">query</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
        <span class="n">query</span><span class="p">[</span><span class="s2">&quot;model_data&quot;</span><span class="p">],</span>
        <span class="n">query</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="n">query</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">),</span> <span class="s2">&quot;MODEL_DATA column empty, retry tclean with savemodel=&#39;modelcolumn&#39;&quot;</span>

    <span class="c1"># subtract model from data</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">model_data</span>

    <span class="c1"># calculate sigma from weight</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">weight</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">*=</span> <span class="n">sigma_rescale</span>

    <span class="c1"># divide by weight, augmented for channel dim</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">residuals</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># separate polarizations</span>
    <span class="n">scatter_XX</span><span class="p">,</span> <span class="n">scatter_YY</span> <span class="o">=</span> <span class="n">scatter</span>
    <span class="n">flag_XX</span><span class="p">,</span> <span class="n">flag_YY</span> <span class="o">=</span> <span class="n">flag</span>

    <span class="k">if</span> <span class="n">apply_flags</span><span class="p">:</span>
        <span class="c1"># flatten across channels</span>
        <span class="n">scatter_XX</span> <span class="o">=</span> <span class="n">scatter_XX</span><span class="p">[</span><span class="o">~</span><span class="n">flag_XX</span><span class="p">]</span>
        <span class="n">scatter_YY</span> <span class="o">=</span> <span class="n">scatter_YY</span><span class="p">[</span><span class="o">~</span><span class="n">flag_YY</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">scatter_XX</span><span class="p">,</span> <span class="n">scatter_YY</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a reference Gaussian as a function of :math:`x`</span>

<span class="sd">    Args:</span>
<span class="sd">        x (float): location to evaluate Gaussian</span>

<span class="sd">    The Gaussian is defined as</span>

<span class="sd">    .. math::</span>

<span class="sd">        f(x) = \frac{1}{\sqrt{2 \pi}} \exp \left ( -\frac{x^2}{2}\right )</span>

<span class="sd">    Returns:</span>
<span class="sd">        Gaussian function evaluated at :math:`x`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scatter_hist</span><span class="p">(</span><span class="n">scatter_XX</span><span class="p">,</span> <span class="n">scatter_YY</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a normalized histogram of scatter for real and imaginary</span>
<span class="sd">    components of XX and YY polarizations.</span>

<span class="sd">    Args:</span>
<span class="sd">        scatter_XX (1D numpy array)</span>
<span class="sd">        scatter_YY (1D numpy array)</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bins&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">scatter_XX</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;$\Re \{ V_\mathrm</span><span class="si">{XX}</span><span class="s2"> - \bar</span><span class="si">{V}</span><span class="s2">_\mathrm</span><span class="si">{XX}</span><span class="s2"> \} / \sigma_\mathrm</span><span class="si">{XX}</span><span class="s2">$&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">scatter_XX</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;$\Im \{ V_\mathrm</span><span class="si">{XX}</span><span class="s2"> - \bar</span><span class="si">{V}</span><span class="s2">_\mathrm</span><span class="si">{XX}</span><span class="s2"> \} / \sigma_\mathrm</span><span class="si">{XX}</span><span class="s2">$&quot;</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">scatter_YY</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;$\Re \{ V_\mathrm</span><span class="si">{YY}</span><span class="s2"> - \bar</span><span class="si">{V}</span><span class="s2">_\mathrm</span><span class="si">{YY}</span><span class="s2"> \} / \sigma_\mathrm</span><span class="si">{YY}</span><span class="s2">$&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">scatter_YY</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;$\Im \{ V_\mathrm</span><span class="si">{YY}</span><span class="s2"> - \bar</span><span class="si">{V}</span><span class="s2">_\mathrm</span><span class="si">{YY}</span><span class="s2"> \} / \sigma_\mathrm</span><span class="si">{YY}</span><span class="s2">$&quot;</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_histogram_datadescid</span><span class="p">(</span>
    <span class="n">datadescid</span><span class="p">,</span> <span class="n">sigma_rescale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap the scatter routine to plot a histogram of scatter for real and imaginary components of XX and YY polarizations, given a ``DATA_DESC_ID``.</span>

<span class="sd">    Args:</span>
<span class="sd">        datadescid (int): the DATA_DESC_ID to be queried</span>
<span class="sd">        sigma_rescale (int):  multiply the uncertainties by this factor</span>
<span class="sd">        log (bool): plot the histogram with a log stretch</span>
<span class="sd">        apply_flags (bool): calculate the scatter *after* the flags have been applied</span>


<span class="sd">    Returns:</span>
<span class="sd">        matplotlib figure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">scatter_XX</span><span class="p">,</span> <span class="n">scatter_YY</span> <span class="o">=</span> <span class="n">get_scatter_datadescid</span><span class="p">(</span>
        <span class="n">datadescid</span><span class="o">=</span><span class="n">datadescid</span><span class="p">,</span> <span class="n">sigma_rescale</span><span class="o">=</span><span class="n">sigma_rescale</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="n">apply_flags</span>
    <span class="p">)</span>

    <span class="n">scatter_XX</span> <span class="o">=</span> <span class="n">scatter_XX</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">scatter_YY</span> <span class="o">=</span> <span class="n">scatter_YY</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">scatter_hist</span><span class="p">(</span><span class="n">scatter_XX</span><span class="p">,</span> <span class="n">scatter_YY</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;DATA_DESC_ID: </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datadescid</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="checking-scatter-for-each-spectral-window">
<h2>Checking scatter for each spectral window<a class="headerlink" href="#checking-scatter-for-each-spectral-window" title="Permalink to this heading">#</a></h2>
<p>Now lets use our helper functions to investigate the characteristics of each spectral window.</p>
<section id="spectral-window-7-a-correctly-scaled-spw">
<h3>Spectral Window 7: A correctly scaled SPW<a class="headerlink" href="#spectral-window-7-a-correctly-scaled-spw" title="Permalink to this heading">#</a></h3>
<p>Let’s see how the residual visibilities in spectral window 7 scatter relative to their expected Gaussian envelope</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_histogram_datadescid</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/364fbd3d65d7ad2063a0ea756dcad907abb855db3df39aa97bc4d609d5561740.png" src="../_images/364fbd3d65d7ad2063a0ea756dcad907abb855db3df39aa97bc4d609d5561740.png" />
</div>
</div>
<p>Great, it looks like things are pretty much as we would expect here.</p>
</section>
<section id="spectral-window-22-visibility-outliers">
<h3>Spectral Window 22: Visibility outliers<a class="headerlink" href="#spectral-window-22-visibility-outliers" title="Permalink to this heading">#</a></h3>
<p>In the last example, we were a little bit cavalier and plotted the residuals for <em>all</em> visibilities, regardless of whether their <code class="docutils literal notranslate"><span class="pre">FLAG</span></code> was true. If we do the same for the visibilities in spectral window 22,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_histogram_datadescid</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/35d625a5e8e5703443089de26fd99185f8227dd8fc2e72607148af681c7ef75b.png" src="../_images/35d625a5e8e5703443089de26fd99185f8227dd8fc2e72607148af681c7ef75b.png" />
</div>
</div>
<p>We find that something looks a little bit strange. Let’s try plotting things on a log scale to get a closer look.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_histogram_datadescid</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/525cb0384bebe95445007cc6fdc6f9ac89589c588c48d4616a6e52a0b204ab5b.png" src="../_images/525cb0384bebe95445007cc6fdc6f9ac89589c588c48d4616a6e52a0b204ab5b.png" />
</div>
</div>
<p>It appears as though there are a bunch of “outlier” visibilities included in this spectral window (the histogram y-axis is the relative frequency or probability density, so in actually there are a relatively small number of outlier visibilities). If the calibration and data preparation processes were done correctly, most likely, these visibilities are actually flagged. Let’s try plotting only the valid, unflagged, visibilities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_histogram_datadescid</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b793cb245473f301d2e98fe2f6479acbac792f213cc4ea2e3645e7e17d2e19fd.png" src="../_images/b793cb245473f301d2e98fe2f6479acbac792f213cc4ea2e3645e7e17d2e19fd.png" />
</div>
</div>
<p>This is certainly an improvement, it looks like all of the egregious outlier visibilities were correctly flagged. However, we also see that the scatter in the visibility residuals is overdispersed relative to the envelope we would expect from the supplied weights. Plotting this on a normal scale might make the discrepancy more visible</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_histogram_datadescid</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b6c0b5784433eb0a0e771d8b5e2c9d535294dc0b7d4ac0f319443addc378e654.png" src="../_images/b6c0b5784433eb0a0e771d8b5e2c9d535294dc0b7d4ac0f319443addc378e654.png" />
</div>
</div>
<p>Lets write a routine to estimate by how much the <span class="math notranslate nohighlight">\(\sigma_0\)</span> values would need to be rescaled in order for the residual visibility scatter to match the expected reference Gaussian.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_rescale_factor</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bins&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">bin_heights</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># find the sigma_rescale which minimizes the mean squared error</span>
    <span class="c1"># between the bin_heights and the expectations from the</span>
    <span class="c1"># reference Gaussian</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">bin_heights</span> <span class="o">-</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">x</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_sigma_rescale_datadescid</span><span class="p">(</span><span class="n">datadescid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">scatter_XX</span><span class="p">,</span> <span class="n">scatter_YY</span> <span class="o">=</span> <span class="n">get_scatter_datadescid</span><span class="p">(</span>
        <span class="n">datadescid</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">calculate_rescale_factor</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">scatter</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">scatter_XX</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
                <span class="n">scatter_XX</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                <span class="n">scatter_YY</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
                <span class="n">scatter_YY</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">factor</span> <span class="o">=</span> <span class="n">get_sigma_rescale_datadescid</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.8596141269242739
</pre></div>
</div>
</div>
</div>
<p>If we rescale the <span class="math notranslate nohighlight">\(\sigma\)</span> values to make them a factor of <span class="math notranslate nohighlight">\(\sim 1.85\)</span> larger it looks like we are able to make the distributions match up a little bit better.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_histogram_datadescid</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="n">sigma_rescale</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b3c4aad8fe2a77c06c21f686ec7e18f35e70d634f6be955c2dfbec429535c4ff.png" src="../_images/b3c4aad8fe2a77c06c21f686ec7e18f35e70d634f6be955c2dfbec429535c4ff.png" />
</div>
</div>
<p>It’s not really clear why this factor works, but factors of <span class="math notranslate nohighlight">\(\sqrt{2}\)</span> and 2 appear in changes to the CASA weight calculations (<a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/calibration-and-visibility-data/data-weights">which have changed across recent CASA versions</a>). Since this DSHARP measurement set contains visibilities acquired in previous ALMA cycles (and potentially calibrated with earlier versions of CASA), these changes in weight definitions may be responsible for the varying weight scatter across spectral window.</p>
<p>To investigate the overdispersion in spectral window 22, lets plot up the rescaled visibilities in the <span class="math notranslate nohighlight">\(u,v\)</span> plane, colorized by their residual values to see if we can discern any patterns that may be the result of an inadequate calibration or CLEAN model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the baselines and flags for spectral window 22</span>
<span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="c1"># select the key</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">datadescid</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s2">&quot;UVW&quot;</span><span class="p">,</span> <span class="s2">&quot;FLAG&quot;</span><span class="p">])</span>
<span class="n">ms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flag_XX</span><span class="p">,</span> <span class="n">flag_YY</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>
<span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;uvw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># [km]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the scatter of the residual visibilities</span>
<span class="n">scatter_XX</span><span class="p">,</span> <span class="n">scatter_YY</span> <span class="o">=</span> <span class="n">get_scatter_datadescid</span><span class="p">(</span>
    <span class="mi">22</span><span class="p">,</span> <span class="n">sigma_rescale</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> <span class="n">apply_flags</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check the array shapes of each of these.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">flag_XX</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scatter_XX</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(16, 297935)
(16, 297935)
(297935,)
</pre></div>
</div>
</div>
</div>
<p>If we want to correctly apply the flags, we’ll need to broadcast the baseline arrays to the full set of channels. (Even though this is a continuum dataset, it does have more than one channel to prevent bandwidth smearing).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nchan</span> <span class="o">=</span> <span class="n">flag_XX</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">broadcast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nchan</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">uu</span> <span class="o">=</span> <span class="n">u</span> <span class="o">*</span> <span class="n">broadcast</span>
<span class="n">vv</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">broadcast</span>
</pre></div>
</div>
</div>
</div>
<p>Now we index the “good” visibilities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uu_XX</span> <span class="o">=</span> <span class="n">uu</span><span class="p">[</span><span class="o">~</span><span class="n">flag_XX</span><span class="p">]</span>
<span class="n">vv_XX</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="o">~</span><span class="n">flag_YY</span><span class="p">]</span>
<span class="n">scatter_XX</span> <span class="o">=</span> <span class="n">scatter_XX</span><span class="p">[</span><span class="o">~</span><span class="n">flag_XX</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uu_YY</span> <span class="o">=</span> <span class="n">uu</span><span class="p">[</span><span class="o">~</span><span class="n">flag_YY</span><span class="p">]</span>
<span class="n">vv_YY</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="o">~</span><span class="n">flag_YY</span><span class="p">]</span>
<span class="n">scatter_YY</span> <span class="o">=</span> <span class="n">scatter_YY</span><span class="p">[</span><span class="o">~</span><span class="n">flag_YY</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vvmax</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="n">vvmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vvmax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">uu_XX</span><span class="p">,</span> <span class="n">vv_XX</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">scatter_XX</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">uu_YY</span><span class="p">,</span> <span class="n">vv_YY</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">scatter_YY</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SPW: </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">22</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$u$ [km]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$v$ [km]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$v$ [km]&#39;)
</pre></div>
</div>
<img alt="../_images/027b3a7bdbe029e1947260dd07450348103f6c81725ac52834272b82e15eeb80.png" src="../_images/027b3a7bdbe029e1947260dd07450348103f6c81725ac52834272b82e15eeb80.png" />
</div>
</div>
<p>We don’t appear to see any large scale pattern with baseline, suggesting that the CLEAN model is doing a reasonable job of fitting the data across many spatial scales. We do see some of the largest outliers (most blue/red) at the beginning (or end) of the tracks. This probably has something to do with a less-than-optimal calibration at the beginning (or end) of the observation. Since there are no large systematic trends with baseline, we’ll just accept these rescaled weights as is.</p>
</section>
</section>
<section id="rescaling-weights-for-export">
<h2>Rescaling weights for export.<a class="headerlink" href="#rescaling-weights-for-export" title="Permalink to this heading">#</a></h2>
<p>We can use the previous routines to iterate through plots of each spectral window. For reference, here are the rescale factors we derived for each spectral window</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sigma_rescale_factors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ID</span><span class="p">:</span> <span class="n">get_sigma_rescale_datadescid</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">SPECTRAL_WINDOW_ID</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">SPECTRAL_WINDOW_ID</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma_rescale_factors</span><span class="p">[</span><span class="n">ID</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1.21
1 1.20
2 1.25
3 1.15
4 1.15
5 1.14
6 1.15
7 1.15
8 1.15
9 1.78
10 1.28
11 1.80
12 1.28
13 1.88
14 1.77
15 1.77
16 1.80
17 1.88
18 1.89
19 1.89
20 1.99
21 1.85
22 1.86
23 1.88
24 1.95
</pre></div>
</div>
</div>
</div>
<p>If you wanted to use these visibilities for forward modeling or <a class="reference external" href="https://mpol-dev.github.io/MPoL/">Regularized Maximum Likelihood (RML) imaging</a>, you will want to read and export the correctly flagged and rescaled visibilities and convert baselines to lambda.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="introduction_to_casatools.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction to CASA tools</p>
      </div>
    </a>
    <a class="right-next"
       href="../casatools-api.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Casatools API</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#obtaining-and-cleaning-the-as-209-measurement-set">Obtaining and CLEANing the AS 209 measurement set</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-visibilities-and-model-data">Model Visibilities and MODEL_DATA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-cleaned-image">Visualizing the CLEANed image</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-measurement-set-structure">Examining measurement set structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-tclean-model-to-calculate-residual-visibilities">Using the tclean model to calculate residual visibilities</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions-for-examining-weight-scatter">Helper functions for examining weight scatter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-scatter-for-each-spectral-window">Checking scatter for each spectral window</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-window-7-a-correctly-scaled-spw">Spectral Window 7: A correctly scaled SPW</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-window-22-visibility-outliers">Spectral Window 22: Visibility outliers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rescaling-weights-for-export">Rescaling weights for export.</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Ian Czekala
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-23, Ian Czekala.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>