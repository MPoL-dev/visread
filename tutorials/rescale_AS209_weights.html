<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities &mdash; visread 0.0.5 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Visread Installation" href="../installation.html" />
    <link rel="prev" title="Introduction to CASA tools" href="introduction_to_casatools.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> visread
          </a>
              <div class="version">
                0.0.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction_to_casatools.html">Introduction to CASA tools</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#obtaining-and-cleaning-the-as-209-measurement-set">Obtaining and CLEANing the AS 209 measurement set</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#model-visibilities-and-model-data">Model Visibilities and MODEL_DATA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visualizing-the-cleaned-image">Visualizing the CLEANed image</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#examining-measurement-set-structure">Examining measurement set structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-the-tclean-model-to-calculate-residual-visibilities">Using the tclean model to calculate residual visibilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#helper-functions-for-examining-weight-scatter">Helper functions for examining weight scatter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#checking-scatter-for-each-spectral-window">Checking scatter for each spectral window</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spectral-window-7-a-correctly-scaled-spw">Spectral Window 7: A correctly scaled SPW</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spectral-window-22-visibility-outliers">Spectral Window 22: Visibility outliers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#rescaling-weights-for-export">Rescaling weights for export.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Visread Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../casatools-api.html">Casatools API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Visread API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">visread</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/rescale_AS209_weights.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%run notebook_setup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/work/visread/visread/docs/tutorials/notebook_setup.py:21: DeprecationWarning: `magic(...)` is deprecated since IPython 0.13 (warning added in 8.1), use run_line_magic(magic_name, parameter_s).
  get_ipython().magic(&#39;config InlineBackend.figure_format = &quot;retina&quot;&#39;)
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="walkthrough-examining-dsharp-as-209-weights-and-exporting-visibilities">
<h1>Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities<a class="headerlink" href="#walkthrough-examining-dsharp-as-209-weights-and-exporting-visibilities" title="Permalink to this heading"></a></h1>
<p>In this walkthrough tutorial, we’ll use CASA tools to examine the visibilities, visibility residuals, and weights of a real multi-configuration dataset from the DSHARP survey.</p>
<section id="obtaining-and-cleaning-the-as-209-measurement-set">
<h2>Obtaining and CLEANing the AS 209 measurement set<a class="headerlink" href="#obtaining-and-cleaning-the-as-209-measurement-set" title="Permalink to this heading"></a></h2>
<p>The calibrated measurement sets from the DSHARP data release are available <a class="reference external" href="https://almascience.eso.org/almadata/lp/DSHARP/">online</a>, and the full description of the survey is provided in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..41A/abstract">Andrews et al. 2018</a>.</p>
<section id="model-visibilities-and-model-data">
<h3>Model Visibilities and MODEL_DATA<a class="headerlink" href="#model-visibilities-and-model-data" title="Permalink to this heading"></a></h3>
<p>In its simplest form, the measurement set just contains the visibility data in a <code class="docutils literal notranslate"><span class="pre">DATA</span></code> or <code class="docutils literal notranslate"><span class="pre">CORRECTED_DATA</span></code> column. In the process of using <code class="docutils literal notranslate"><span class="pre">tclean</span></code> to synthesize an image, however, CASA also calculates a set of model visibilities that correspond to the Fourier transform of the CLEAN model. It’s possible to store these model visibilities to the measurement set if the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> process was invoked with the <code class="docutils literal notranslate"><span class="pre">savemodel=&quot;modelcolumn&quot;</span></code> parameter. The model visibilities will be stored in a <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column with the same shape as the <code class="docutils literal notranslate"><span class="pre">DATA</span></code> column.</p>
<p>The calibrated DSHARP measurement sets available from the archive do not contain this <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column (most likely for space reasons), so we will need to recreate them by running the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> algorithm with the relevant settings. The full reduction scripts are <a class="reference external" href="https://almascience.eso.org/almadata/lp/DSHARP/scripts/AS209_continuum.py">available online</a>, but we just need reproduce the relevant <code class="docutils literal notranslate"><span class="pre">tclean</span></code> commands used to produce a FITS image from the final, calibrated measurement set.</p>
<p>Because the measurement set is large (0.9 Gb) and the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> process is computationally expensive (taking about 1 hr on a single core), we have pre-executed those commands and cached the measurement set and <code class="docutils literal notranslate"><span class="pre">tclean</span></code> products into the <code class="docutils literal notranslate"><span class="pre">AS209_MS</span></code> local directory. If you’re interested in the exact <code class="docutils literal notranslate"><span class="pre">tclean</span></code> commands used, please check out the <a class="reference download internal" download="" href="../_downloads/c7dd1c1b360aefbae562788776b2e7e5/dl_and_tclean_AS209.py"><span class="xref download myst">dl_and_tclean_AS209.py</span></a> script directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
import matplotlib
import matplotlib.pyplot as plt
import os
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># change to the cached subdirectory that contains the cleaned MS
workdir = &quot;AS209_MS&quot;
os.chdir(workdir)
fname = &quot;AS209_continuum.ms&quot;
fitsname = &quot;AS209.fits&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-the-cleaned-image">
<h3>Visualizing the CLEANed image<a class="headerlink" href="#visualizing-the-cleaned-image" title="Permalink to this heading"></a></h3>
<p>Just to make sure the <code class="docutils literal notranslate"><span class="pre">tclean</span></code> process ran OK, let’s check the synthesized image that was produced</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from astropy.io import fits
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>hdul = fits.open(fitsname)
header = hdul[0].header
data = 1e3 * hdul[0].data  # mJy/pixel
# get the coordinate labels
nx = header[&quot;NAXIS1&quot;]
ny = header[&quot;NAXIS2&quot;]
# RA coordinates
CDELT1 = 3600 * header[&quot;CDELT1&quot;]  # arcsec (converted from decimal deg)
CRPIX1 = header[&quot;CRPIX1&quot;] - 1.0  # Now indexed from 0
# DEC coordinates
CDELT2 = 3600 * header[&quot;CDELT2&quot;]  # arcsec
CRPIX2 = header[&quot;CRPIX2&quot;] - 1.0  # Now indexed from 0
RA = (np.arange(nx) - nx / 2) * CDELT1  # [arcsec]
DEC = (np.arange(ny) - ny / 2) * CDELT2  # [arcsec]
# extent needs to include extra half-pixels.
# RA, DEC are pixel centers
ext = (
    RA[0] - CDELT1 / 2,
    RA[-1] + CDELT1 / 2,
    DEC[0] - CDELT2 / 2,
    DEC[-1] + CDELT2 / 2,
)  # [arcsec]
norm = matplotlib.colors.Normalize(vmin=0, vmax=np.max(data))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(nrows=1, figsize=(4.5, 3.5))
fig.subplots_adjust(left=0.2, bottom=0.2)
im = ax.imshow(data, extent=ext, origin=&quot;lower&quot;, animated=True, norm=norm)
cb = plt.colorbar(im, label=&quot;mJy / pixel&quot;)
r = 2.2
ax.set_xlim(r, -r)
ax.set_ylim(-r, r)
ax.set_xlabel(r&quot;$\Delta \alpha \cos \delta$ [${}^{\prime\prime}$]&quot;)
ax.set_ylabel(r&quot;$\Delta \delta$ [${}^{\prime\prime}$]&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$\\Delta \\delta$ [${}^{\\prime\\prime}$]&#39;)
</pre></div>
</div>
<img alt="../_images/02b2063ecd475aa8a3205894dd8f67069dc449278deb7ab0e05749cff51ddc5f.png" src="../_images/02b2063ecd475aa8a3205894dd8f67069dc449278deb7ab0e05749cff51ddc5f.png" />
</div>
</div>
<p>Great, it looks like things check out. Note that the main reason (at least for this tutorial) that we ran <code class="docutils literal notranslate"><span class="pre">tclean</span></code> was to generate the <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column in the measurement set. The actual CLEANed FITS image is just a nice byproduct.</p>
</section>
</section>
<section id="examining-measurement-set-structure">
<h2>Examining measurement set structure<a class="headerlink" href="#examining-measurement-set-structure" title="Permalink to this heading"></a></h2>
<p>Before you dive into the full analysis with CASA tools, it’s a very good idea to inspect the measurement set using <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-task-list/task_listobs/about">listobs</a>.</p>
<p>After you’ve done that, let’s start exploring the visibility values. First we’ll need to import and then instantiate the relevant CASA tools, <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-tool-list/tool_table/methods">table</a> and <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-tool-list/tool_ms/methods">ms</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import casatools
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tb = casatools.table()
ms = casatools.ms()
</pre></div>
</div>
</div>
</div>
<p>We can get the indexes of the unique spectral windows, which are typically indexed by the <code class="docutils literal notranslate"><span class="pre">DATA_DESC_ID</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tb.open(fname + &quot;/DATA_DESCRIPTION&quot;)
SPECTRAL_WINDOW_ID = tb.getcol(&quot;SPECTRAL_WINDOW_ID&quot;)
tb.close()
print(SPECTRAL_WINDOW_ID)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
 24]
</pre></div>
</div>
</div>
</div>
<p>We see that there are 25 separate spectral windows! This is because the DSHARP images were produced using all available Band 6 continuum data on each source—not just the long baseline observations acquired in ALMA cycle 4. The merging of all of these individual observations is what creates this structure with so many spectral windows.</p>
<p>Next, let’s open the main table of the measurement set and inspect the column names</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tb.open(fname)
colnames = tb.colnames()
tb.close()
print(colnames)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;UVW&#39;, &#39;FLAG&#39;, &#39;FLAG_CATEGORY&#39;, &#39;WEIGHT&#39;, &#39;SIGMA&#39;, &#39;ANTENNA1&#39;, &#39;ANTENNA2&#39;, &#39;ARRAY_ID&#39;, &#39;DATA_DESC_ID&#39;, &#39;EXPOSURE&#39;, &#39;FEED1&#39;, &#39;FEED2&#39;, &#39;FIELD_ID&#39;, &#39;FLAG_ROW&#39;, &#39;INTERVAL&#39;, &#39;OBSERVATION_ID&#39;, &#39;PROCESSOR_ID&#39;, &#39;SCAN_NUMBER&#39;, &#39;STATE_ID&#39;, &#39;TIME&#39;, &#39;TIME_CENTROID&#39;, &#39;DATA&#39;, &#39;WEIGHT_SPECTRUM&#39;, &#39;SIGMA_SPECTRUM&#39;, &#39;MODEL_DATA&#39;]
</pre></div>
</div>
</div>
</div>
<p>Because there are multiple spectral windows which do not share the same dimensions, we cannot use the <code class="docutils literal notranslate"><span class="pre">tb</span></code> tool to read the data directly. If we try, we’ll get an error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>try:
    tb.open(fname)
    weight = tb.getcol(&quot;WEIGHT&quot;)  # array of float64 with shape [npol, nvis]
    flag = tb.getcol(&quot;FLAG&quot;)  # array of bool with shape [npol, nchan, nvis]
    data = tb.getcol(&quot;DATA&quot;)  # array of complex128 with shape [npol, nchan, nvis]
except RuntimeError:
    print(
        &quot;We can&#39;t use table tools here... the spws have different numbers of channels&quot;
    )
finally:
    tb.close()
</pre></div>
</div>
</div>
</div>
<p>So, we’ll need to use the <code class="docutils literal notranslate"><span class="pre">ms</span></code> tool to read the visibilities for each spectral window, like so</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ms.open(fname)
# select the spectral window
ms.selectinit(datadescid=0)
# query the desired columnames as a list
query = ms.getdata([&quot;WEIGHT&quot;, &quot;UVW&quot;, &quot;DATA&quot;])
# always a good idea to reset the earmarked data
ms.selectinit(reset=True)
ms.close()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>The returned query is a dictionary whose keys are the lowercase column names</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(query.keys())
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;data&#39;, &#39;uvw&#39;, &#39;weight&#39;])
</pre></div>
</div>
</div>
</div>
<p>and whose values are the numerical arrays for the spectral window that we queried</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(query[&quot;data&quot;])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[[-0.09359986-0.07905877j  0.19716288+0.10789031j
   -0.04736413-0.38649508j ...  0.4015328 +0.23623116j
    0.20422684+0.29638007j  0.13025568-0.55658323j]]

 [[ 0.43320566-0.16495545j -0.0630829 -0.10485866j
   -0.36411372-0.40655291j ...  0.24039683-0.32688245j
    0.46174076-0.27798796j  0.61960417+0.00973242j]]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-the-tclean-model-to-calculate-residual-visibilities">
<h2>Using the tclean model to calculate residual visibilities<a class="headerlink" href="#using-the-tclean-model-to-calculate-residual-visibilities" title="Permalink to this heading"></a></h2>
<p>In any data analysis where you’re computing a forward model, it’s a good consitency check to examine the data residuals from that model, and, in particular, whether their scatter matches the expectations from the noise properties.</p>
<p>We can calculate data residuals using the model visibilities derived from the tclean model and stored in the <code class="docutils literal notranslate"><span class="pre">MODEL_DATA</span></code> column of the measurement set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ms.open(fname)
# select the spectral window
ms.selectinit(datadescid=0)
# query the desired columnames as a list
query = ms.getdata([&quot;MODEL_DATA&quot;])
# always a good idea to reset the earmarked data
ms.selectinit(reset=True)
ms.close()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(query[&quot;model_data&quot;])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[[0.05795327-0.00037503j 0.06064697-0.0005148j  0.03213371-0.0003984j
   ... 0.05897298-0.00039497j 0.06831173-0.00042475j
   0.19711027-0.00065186j]]

 [[0.05795327-0.00037503j 0.06064697-0.0005148j  0.03213371-0.0003984j
   ... 0.05897298-0.00039497j 0.06831173-0.00042475j
   0.19711027-0.00065186j]]]
</pre></div>
</div>
</div>
</div>
<p>Using these model visibilities, let’s calculate the residuals for each polarization (XX, YY) in units of <span class="math notranslate nohighlight">\(\sigma\)</span>, where</p>
<div class="math notranslate nohighlight">
\[
\sigma = \mathrm{sigma\_rescale} \times \sigma_0
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\sigma_0 = \sqrt{1/w}
\]</div>
<p>The scatter is defined as</p>
<div class="math notranslate nohighlight">
\[
\mathrm{scatter} = \frac{\mathrm{DATA} - \mathrm{MODEL\_DATA}}{\sigma}
\]</div>
<p>For now, <span class="math notranslate nohighlight">\(\mathrm{sigma\_rescale} = 1\)</span>, but we’ll see why this parameter is needed in a moment.</p>
<section id="helper-functions-for-examining-weight-scatter">
<h3>Helper functions for examining weight scatter<a class="headerlink" href="#helper-functions-for-examining-weight-scatter" title="Permalink to this heading"></a></h3>
<p>Because we’d like to repeat this analysis for each spectral window in the measurement set, it makes things easier if we write these calculations as functions.</p>
<p>The functions provided in this document are only dependent on the CASA tools <code class="docutils literal notranslate"><span class="pre">tb</span></code> and <code class="docutils literal notranslate"><span class="pre">ms</span></code>. If you find yourself using these routines frequently, you might consider installing the <em>visread</em> package, since similar commands are provided in the API.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def get_scatter_datadescid(datadescid, sigma_rescale=1.0, apply_flags=True):
    &quot;&quot;&quot;
    Calculate the scatter for each polarization.

    Args:
        datadescid (int): the DATA_DESC_ID to be queried
        sigma_rescale (int):  multiply the uncertainties by this factor
        apply_flags (bool): calculate the scatter *after* the flags have been applied

    Returns:
        scatter_XX, scatter_YY: a 2-tuple of numpy arrays containing the scatter in each polarization.
        If ``apply_flags==True``, each array will be 1-dimensional. If ``apply_flags==False``, each array
        will retain its original shape, including channelization (e.g., shape ``nchan,nvis``).
    &quot;&quot;&quot;
    ms.open(fname)
    # select the key
    ms.selectinit(datadescid=datadescid)
    query = ms.getdata(
        [&quot;DATA&quot;, &quot;MODEL_DATA&quot;, &quot;WEIGHT&quot;, &quot;UVW&quot;, &quot;ANTENNA1&quot;, &quot;ANTENNA2&quot;, &quot;FLAG&quot;]
    )
    ms.selectinit(reset=True)
    ms.close()

    data, model_data, weight, flag = (
        query[&quot;data&quot;],
        query[&quot;model_data&quot;],
        query[&quot;weight&quot;],
        query[&quot;flag&quot;],
    )

    assert (
        len(model_data) &gt; 0
    ), &quot;MODEL_DATA column empty, retry tclean with savemodel=&#39;modelcolumn&#39;&quot;

    # subtract model from data
    residuals = data - model_data

    # calculate sigma from weight
    sigma = np.sqrt(1 / weight)
    sigma *= sigma_rescale

    # divide by weight, augmented for channel dim
    scatter = residuals / sigma[:, np.newaxis, :]

    # separate polarizations
    scatter_XX, scatter_YY = scatter
    flag_XX, flag_YY = flag

    if apply_flags:
        # flatten across channels
        scatter_XX = scatter_XX[~flag_XX]
        scatter_YY = scatter_YY[~flag_YY]

    return scatter_XX, scatter_YY
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def gaussian(x, sigma=1):
    r&quot;&quot;&quot;
    Evaluate a reference Gaussian as a function of :math:`x`

    Args:
        x (float): location to evaluate Gaussian

    The Gaussian is defined as

    .. math::

        f(x) = \frac{1}{\sqrt{2 \pi}} \exp \left ( -\frac{x^2}{2}\right )

    Returns:
        Gaussian function evaluated at :math:`x`
    &quot;&quot;&quot;
    return 1 / (sigma * np.sqrt(2 * np.pi)) * np.exp(-0.5 * (x / sigma) ** 2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def scatter_hist(scatter_XX, scatter_YY, log=False, **kwargs):
    &quot;&quot;&quot;
    Plot a normalized histogram of scatter for real and imaginary
    components of XX and YY polarizations.

    Args:
        scatter_XX (1D numpy array)
        scatter_YY (1D numpy array)

    Returns:
        matplotlib figure
    &quot;&quot;&quot;
    xs = np.linspace(-5, 5)

    figsize = kwargs.get(&quot;figsize&quot;, (6, 6))
    bins = kwargs.get(&quot;bins&quot;, 40)

    fig, ax = plt.subplots(ncols=2, nrows=2, figsize=figsize)
    ax[0, 0].hist(scatter_XX.real, bins=bins, density=True, log=log)
    ax[0, 0].set_xlabel(
        r&quot;$\Re \{ V_\mathrm{XX} - \bar{V}_\mathrm{XX} \} / \sigma_\mathrm{XX}$&quot;
    )
    ax[0, 1].hist(scatter_XX.imag, bins=bins, density=True, log=log)
    ax[0, 1].set_xlabel(
        r&quot;$\Im \{ V_\mathrm{XX} - \bar{V}_\mathrm{XX} \} / \sigma_\mathrm{XX}$&quot;
    )

    ax[1, 0].hist(scatter_YY.real, bins=bins, density=True, log=log)
    ax[1, 0].set_xlabel(
        r&quot;$\Re \{ V_\mathrm{YY} - \bar{V}_\mathrm{YY} \} / \sigma_\mathrm{YY}$&quot;
    )
    ax[1, 1].hist(scatter_YY.imag, bins=bins, density=True, log=log)
    ax[1, 1].set_xlabel(
        r&quot;$\Im \{ V_\mathrm{YY} - \bar{V}_\mathrm{YY} \} / \sigma_\mathrm{YY}$&quot;
    )

    for a in ax.flatten():
        a.plot(xs, gaussian(xs))

    fig.subplots_adjust(hspace=0.25, top=0.92)

    return fig
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_histogram_datadescid(
    datadescid, sigma_rescale=1.0, log=False, apply_flags=True
):
    &quot;&quot;&quot;Wrap the scatter routine to plot a histogram of scatter for real and imaginary components of XX and YY polarizations, given a ``DATA_DESC_ID``.

    Args:
        datadescid (int): the DATA_DESC_ID to be queried
        sigma_rescale (int):  multiply the uncertainties by this factor
        log (bool): plot the histogram with a log stretch
        apply_flags (bool): calculate the scatter *after* the flags have been applied


    Returns:
        matplotlib figure
    &quot;&quot;&quot;

    scatter_XX, scatter_YY = get_scatter_datadescid(
        datadescid=datadescid, sigma_rescale=sigma_rescale, apply_flags=apply_flags
    )

    scatter_XX = scatter_XX.flatten()
    scatter_YY = scatter_YY.flatten()

    fig = scatter_hist(scatter_XX, scatter_YY, log=log)
    fig.suptitle(&quot;DATA_DESC_ID: {:}&quot;.format(datadescid))
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="checking-scatter-for-each-spectral-window">
<h2>Checking scatter for each spectral window<a class="headerlink" href="#checking-scatter-for-each-spectral-window" title="Permalink to this heading"></a></h2>
<p>Now lets use our helper functions to investigate the characteristics of each spectral window.</p>
<section id="spectral-window-7-a-correctly-scaled-spw">
<h3>Spectral Window 7: A correctly scaled SPW<a class="headerlink" href="#spectral-window-7-a-correctly-scaled-spw" title="Permalink to this heading"></a></h3>
<p>Let’s see how the residual visibilities in spectral window 7 scatter relative to their expected Gaussian envelope</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_histogram_datadescid(7, apply_flags=False)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/460e8485f12e2d2b9185f6528193e51c2aa991c75a3670227f89da38d603bd66.png" src="../_images/460e8485f12e2d2b9185f6528193e51c2aa991c75a3670227f89da38d603bd66.png" />
</div>
</div>
<p>Great, it looks like things are pretty much as we would expect here.</p>
</section>
<section id="spectral-window-22-visibility-outliers">
<h3>Spectral Window 22: Visibility outliers<a class="headerlink" href="#spectral-window-22-visibility-outliers" title="Permalink to this heading"></a></h3>
<p>In the last example, we were a little bit cavalier and plotted the residuals for <em>all</em> visibilities, regardless of whether their <code class="docutils literal notranslate"><span class="pre">FLAG</span></code> was true. If we do the same for the visibilities in spectral window 22,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_histogram_datadescid(22, apply_flags=False)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/737d169ff5785cba599d308ca7707178be26f01124a4c3d0a910052e1429082f.png" src="../_images/737d169ff5785cba599d308ca7707178be26f01124a4c3d0a910052e1429082f.png" />
</div>
</div>
<p>We find that something looks a little bit strange. Let’s try plotting things on a log scale to get a closer look.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_histogram_datadescid(22, apply_flags=False, log=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/45459f0bfd8cf45708d4f714677c0b8f20417407ff1218ca794024f4a7ef8346.png" src="../_images/45459f0bfd8cf45708d4f714677c0b8f20417407ff1218ca794024f4a7ef8346.png" />
</div>
</div>
<p>It appears as though there are a bunch of “outlier” visibilities included in this spectral window (the histogram y-axis is the relative frequency or probability density, so in actually there are a relatively small number of outlier visibilities). If the calibration and data preparation processes were done correctly, most likely, these visibilities are actually flagged. Let’s try plotting only the valid, unflagged, visibilities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_histogram_datadescid(22, apply_flags=True, log=True)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/18725d074857b704d83faa315a95368be1230f4b5bcb3bab656ae027718def90.png" src="../_images/18725d074857b704d83faa315a95368be1230f4b5bcb3bab656ae027718def90.png" />
</div>
</div>
<p>This is certainly an improvement, it looks like all of the egregious outlier visibilities were correctly flagged. However, we also see that the scatter in the visibility residuals is overdispersed relative to the envelope we would expect from the supplied weights. Plotting this on a normal scale might make the discrepancy more visible</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_histogram_datadescid(22, apply_flags=True, log=False)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/78acd938f5c7eb05d0e7732d045a8d54814ce06abe7318818f0844f4afecf7c3.png" src="../_images/78acd938f5c7eb05d0e7732d045a8d54814ce06abe7318818f0844f4afecf7c3.png" />
</div>
</div>
<p>Lets write a routine to estimate by how much the <span class="math notranslate nohighlight">\(\sigma_0\)</span> values would need to be rescaled in order for the residual visibility scatter to match the expected reference Gaussian.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from scipy.optimize import minimize
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def calculate_rescale_factor(scatter, **kwargs):
    bins = kwargs.get(&quot;bins&quot;, 40)
    bin_heights, bin_edges = np.histogram(scatter, density=True, bins=bins)
    bin_centers = bin_edges[:-1] + np.diff(bin_edges) / 2

    # find the sigma_rescale which minimizes the mean squared error
    # between the bin_heights and the expectations from the
    # reference Gaussian

    loss = lambda x: np.sum((bin_heights - gaussian(bin_centers, sigma=x)) ** 2)

    res = minimize(loss, 1.0)

    if res.success:
        return res.x[0]
    else:
        print(res)
        return False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def get_sigma_rescale_datadescid(datadescid, **kwargs):
    scatter_XX, scatter_YY = get_scatter_datadescid(
        datadescid, apply_flags=True, **kwargs
    )
    vals = np.array(
        [
            calculate_rescale_factor(scatter)
            for scatter in [
                scatter_XX.real,
                scatter_XX.imag,
                scatter_YY.real,
                scatter_YY.imag,
            ]
        ]
    )

    return np.average(vals)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>factor = get_sigma_rescale_datadescid(22)
print(factor)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.8596319521755138
</pre></div>
</div>
</div>
</div>
<p>If we rescale the <span class="math notranslate nohighlight">\(\sigma\)</span> values to make them a factor of <span class="math notranslate nohighlight">\(\sim 1.85\)</span> larger it looks like we are able to make the distributions match up a little bit better.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_histogram_datadescid(22, sigma_rescale=factor, apply_flags=True, log=False)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/32f91ef968c41c98b0b7ba04e13354c5a669a1d3850214be410834e6a99c3dec.png" src="../_images/32f91ef968c41c98b0b7ba04e13354c5a669a1d3850214be410834e6a99c3dec.png" />
</div>
</div>
<p>It’s not really clear why this factor works, but factors of <span class="math notranslate nohighlight">\(\sqrt{2}\)</span> and 2 appear in changes to the CASA weight calculations (<a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/calibration-and-visibility-data/data-weights">which have changed across recent CASA versions</a>). Since this DSHARP measurement set contains visibilities acquired in previous ALMA cycles (and potentially calibrated with earlier versions of CASA), these changes in weight definitions may be responsible for the varying weight scatter across spectral window.</p>
<p>To investigate the overdispersion in spectral window 22, lets plot up the rescaled visibilities in the <span class="math notranslate nohighlight">\(u,v\)</span> plane, colorized by their residual values to see if we can discern any patterns that may be the result of an inadequate calibration or CLEAN model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># get the baselines and flags for spectral window 22
ms.open(fname)
# select the key
ms.selectinit(datadescid=22)
query = ms.getdata([&quot;UVW&quot;, &quot;FLAG&quot;])
ms.selectinit(reset=True)
ms.close()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>flag_XX, flag_YY = query[&quot;flag&quot;]
u, v, w = query[&quot;uvw&quot;] * 1e-3  # [km]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># calculate the scatter of the residual visibilities
scatter_XX, scatter_YY = get_scatter_datadescid(
    22, sigma_rescale=factor, apply_flags=False
)
</pre></div>
</div>
</div>
</div>
<p>Let’s check the array shapes of each of these.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(flag_XX.shape)
print(scatter_XX.shape)
print(u.shape)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(16, 297935)
(16, 297935)
(297935,)
</pre></div>
</div>
</div>
</div>
<p>If we want to correctly apply the flags, we’ll need to broadcast the baseline arrays to the full set of channels. (Even though this is a continuum dataset, it does have more than one channel to prevent bandwidth smearing).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nchan = flag_XX.shape[0]
broadcast = np.ones((nchan, 1))
uu = u * broadcast
vv = v * broadcast
</pre></div>
</div>
</div>
</div>
<p>Now we index the “good” visibilities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>uu_XX = uu[~flag_XX]
vv_XX = vv[~flag_YY]
scatter_XX = scatter_XX[~flag_XX]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>uu_YY = uu[~flag_YY]
vv_YY = vv[~flag_YY]
scatter_YY = scatter_YY[~flag_YY]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>vvmax = 5
norm = matplotlib.colors.Normalize(vmin=-vvmax, vmax=vvmax)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(nrows=1, figsize=(4, 4))
ax.scatter(uu_XX, vv_XX, s=0.1, c=scatter_XX.real, cmap=&quot;bwr&quot;, norm=norm)
im = ax.scatter(uu_YY, vv_YY, s=0.1, c=scatter_YY.real, cmap=&quot;bwr&quot;, norm=norm)
plt.colorbar(im, ax=ax)
ax.set_title(&quot;SPW: {:}&quot;.format(22))
ax.set_aspect(&quot;equal&quot;)
ax.set_xlabel(r&quot;$u$ [km]&quot;)
ax.set_ylabel(r&quot;$v$ [km]&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$v$ [km]&#39;)
</pre></div>
</div>
<img alt="../_images/9a395873b3054c51a620719fb2771574337257cde201fdc2f127ec4d34a9e096.png" src="../_images/9a395873b3054c51a620719fb2771574337257cde201fdc2f127ec4d34a9e096.png" />
</div>
</div>
<p>We don’t appear to see any large scale pattern with baseline, suggesting that the CLEAN model is doing a reasonable job of fitting the data across many spatial scales. We do see some of the largest outliers (most blue/red) at the beginning (or end) of the tracks. This probably has something to do with a less-than-optimal calibration at the beginning (or end) of the observation. Since there are no large systematic trends with baseline, we’ll just accept these rescaled weights as is.</p>
</section>
</section>
<section id="rescaling-weights-for-export">
<h2>Rescaling weights for export.<a class="headerlink" href="#rescaling-weights-for-export" title="Permalink to this heading"></a></h2>
<p>We can use the previous routines to iterate through plots of each spectral window. For reference, here are the rescale factors we derived for each spectral window</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sigma_rescale_factors = {
    ID: get_sigma_rescale_datadescid(ID) for ID in SPECTRAL_WINDOW_ID
}
for ID in SPECTRAL_WINDOW_ID:
    print(ID, &quot;{:.2f}&quot;.format(sigma_rescale_factors[ID]))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1.21
1 1.20
2 1.25
3 1.15
4 1.15
5 1.14
6 1.15
7 1.15
8 1.15
9 1.78
10 1.28
11 1.80
12 1.28
13 1.88
14 1.77
15 1.77
16 1.80
17 1.88
18 1.89
19 1.89
20 1.99
21 1.85
22 1.86
23 1.88
24 1.95
</pre></div>
</div>
</div>
</div>
<p>If you wanted to use these visibilities for forward modeling or <a class="reference external" href="https://mpol-dev.github.io/MPoL/">Regularized Maximum Likelihood (RML) imaging</a>, you will want to read and export the correctly flagged and rescaled visibilities and convert baselines to kilolambda.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="introduction_to_casatools.html" class="btn btn-neutral float-left" title="Introduction to CASA tools" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../installation.html" class="btn btn-neutral float-right" title="Visread Installation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-23, Ian Czekala.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>