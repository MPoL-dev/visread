<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction to CASA tools &mdash; visread 0.0.5 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities" href="rescale_AS209_weights.html" />
    <link rel="prev" title="Visread documentation" href="../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> visread
          </a>
              <div class="version">
                0.0.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction to CASA tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-measurement-sets">Introduction to measurement sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mock-data-set">Mock data set</a></li>
<li class="toctree-l2"><a class="reference internal" href="#casa-tools-setup">CASA tools setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-metadata-queries">Example metadata queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#column-names-of-main-table">Column names of main table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unique-spectral-window-ids">Unique spectral window IDs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-many-channels-in-each-spw">How many channels in each spw</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example-ms-tool-queries">Example ms tool queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-baselines">Working with baselines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#get-the-baselines">Get the baselines</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-baselines-to-units-of-kilolambda">Convert baselines to units of kilolambda</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-visibilities">Working with visibilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#read-the-visibility-values-and-inspect-flags">Read the visibility values and inspect flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-visibility-values-and-averaging-polarizations">Read visibility values and averaging polarizations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exporting-visibilities">Exporting visibilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="rescale_AS209_weights.html">Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Visread Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../casatools-api.html">Casatools API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Visread API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">visread</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Introduction to CASA tools</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/introduction_to_casatools.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%run notebook_setup
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/work/visread/visread/docs/tutorials/notebook_setup.py:21: DeprecationWarning: `magic(...)` is deprecated since IPython 0.13 (warning added in 8.1), use run_line_magic(magic_name, parameter_s).
  get_ipython().magic(&#39;config InlineBackend.figure_format = &quot;retina&quot;&#39;)
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="introduction-to-casa-tools">
<h1>Introduction to CASA tools<a class="headerlink" href="#introduction-to-casa-tools" title="Permalink to this heading"></a></h1>
<p>This tutorial is meant to provide an introduction to working with some the ‘tools’ provided in the CASA package. In particular, we’ll focus on the <code class="docutils literal notranslate"><span class="pre">msmetadata</span></code>, <code class="docutils literal notranslate"><span class="pre">tb</span></code>, and <code class="docutils literal notranslate"><span class="pre">ms</span></code> tools.</p>
<section id="introduction-to-measurement-sets">
<h2>Introduction to measurement sets<a class="headerlink" href="#introduction-to-measurement-sets" title="Permalink to this heading"></a></h2>
<p>Before you begin, it’s worthwhile reviewing the CASA documentation on the measurement set, which is the default storage format for radio interferometric observations. The basics are <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/notebooks/casa-fundamentals.html#MeasurementSet-Basics">here</a>. To make a long story short, a measurement set (e.g., <code class="docutils literal notranslate"><span class="pre">my_ALMA_data.ms</span></code>) is a folder containing a set of binary ‘tables’ with your data and metadata. The contents within this measurement set folder serve as a <a class="reference external" href="https://en.wikipedia.org/wiki/Relational_database">relational database</a>. It helps to keep this structure in mind as we navigate its contents.</p>
<p>A good first task is to load up an interactive prompt of CASA and work through the <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/notebooks/data_examination.html">Data Examination</a> routines like <code class="docutils literal notranslate"><span class="pre">listobs</span></code> and <code class="docutils literal notranslate"><span class="pre">plotms</span></code> to familiarize yourself with the basic structure of your measurement set.</p>
<p>It will be very helpful to know things like how many spectral windows there are, how many execution blocks there are, and what targets were observed. Hopefully you’ve already <code class="docutils literal notranslate"><span class="pre">split</span></code> out your data such that it only contains the target under consideration and does not include any extra calibrator targets, which can simplify many of the queries.</p>
<p>CASA also provides the <code class="docutils literal notranslate"><span class="pre">casabrowser/browsetable</span></code>tool, which is very handy for graphically exploring the structure and contents of this relational database. If something about the structure of the measurement set doesn’t make sense, it’s usually a good idea to open up <code class="docutils literal notranslate"><span class="pre">browsetable</span></code> and dig into the structure of the individual tables.</p>
</section>
<section id="mock-data-set">
<h2>Mock data set<a class="headerlink" href="#mock-data-set" title="Permalink to this heading"></a></h2>
<p>To experiment with reading and plotting visibilities, we’ll use a measurement set that we prepared using simobserve. The full commands to generate the measurement set are available via the <code class="docutils literal notranslate"><span class="pre">mpoldatasets</span></code> package <a class="reference external" href="https://github.com/MPoL-dev/mpoldatasets/blob/main/products/ALMA-logo/simobserve_cube.py">here</a>, but you could just as easily use your own measurement set. You can download the measurement set using the following commands.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
import matplotlib.pyplot as plt
from astropy.constants import c
from astropy.utils.data import download_file
import tempfile
import tarfile
import os
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># load the mock dataset of the ALMA logo
fname_tar = download_file(
    &quot;https://zenodo.org/record/4711811/files/logo_cube.noise.ms.tar.gz&quot;,
    cache=True,
    show_progress=True,
    pkgname=&quot;mpol&quot;,
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># extract the measurement set to a local directory
temp_dir = tempfile.TemporaryDirectory()
curdir = os.getcwd()
os.chdir(temp_dir.name)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>with tarfile.open(fname_tar) as tar:
    tar.extractall()
</pre></div>
</div>
</div>
</div>
<p>Now we’ve successfully downloaded and extracted the measurement set</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!ls 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>logo_cube.noise.ms
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fname = &quot;logo_cube.noise.ms&quot;
</pre></div>
</div>
</div>
</div>
<p>If you’re working with your own measurement set, you can start from the next section.</p>
</section>
<section id="casa-tools-setup">
<h2>CASA tools setup<a class="headerlink" href="#casa-tools-setup" title="Permalink to this heading"></a></h2>
<p>CASA provides a set of lower-level “tools” for direct interaction with the measurement set contents. The full API list is available <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casatools.html">here</a>. You can access the CASA tools from within your Python environment if you’ve successfully installed <code class="docutils literal notranslate"><span class="pre">casatools</span></code> package. If you are unable to install the modular package, you can always use the casatools directly inside of the monolithic CASA intepreter. If you’re working directly within the CASA interpreter, you can skip this section and move directly to the example queries.</p>
<p>Let’s import and then instantiate the relevant CASA tools, <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/tt/casatools.msmetadata.html#casatools.msmetadata">msmetadata</a>, <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/tt/casatools.ms.html">ms</a>, and <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/tt/casatools.table.html">table</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import casatools
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>msmd = casatools.msmetadata()
ms = casatools.ms()
tb = casatools.table()
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-metadata-queries">
<h2>Example metadata queries<a class="headerlink" href="#example-metadata-queries" title="Permalink to this heading"></a></h2>
<section id="column-names-of-main-table">
<h3>Column names of main table<a class="headerlink" href="#column-names-of-main-table" title="Permalink to this heading"></a></h3>
<p>Open the main table of the measurement set and inspect the column names</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tb.open(fname)
colnames = tb.colnames()
tb.close()
print(colnames)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;UVW&#39;, &#39;FLAG&#39;, &#39;FLAG_CATEGORY&#39;, &#39;WEIGHT&#39;, &#39;SIGMA&#39;, &#39;ANTENNA1&#39;, &#39;ANTENNA2&#39;, &#39;ARRAY_ID&#39;, &#39;DATA_DESC_ID&#39;, &#39;EXPOSURE&#39;, &#39;FEED1&#39;, &#39;FEED2&#39;, &#39;FIELD_ID&#39;, &#39;FLAG_ROW&#39;, &#39;INTERVAL&#39;, &#39;OBSERVATION_ID&#39;, &#39;PROCESSOR_ID&#39;, &#39;SCAN_NUMBER&#39;, &#39;STATE_ID&#39;, &#39;TIME&#39;, &#39;TIME_CENTROID&#39;, &#39;DATA&#39;, &#39;MODEL_DATA&#39;, &#39;CORRECTED_DATA&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="unique-spectral-window-ids">
<h3>Unique spectral window IDs<a class="headerlink" href="#unique-spectral-window-ids" title="Permalink to this heading"></a></h3>
<p>Get the indexes of the unique spectral windows, typically indexed by the <code class="docutils literal notranslate"><span class="pre">DATA_DESC_ID</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>msmd.open(fname)
spws = msmd.datadescids() 
msmd.done()
print(spws)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-12-27 19:23:26	INFO	msmetadata_cmpt.cc::open	Performing internal consistency checks on logo_cube.noise.ms...
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">DATA_DESC_ID</span></code> might not always be a perfect stand-in for <code class="docutils literal notranslate"><span class="pre">SPECTRAL_WINDOW_ID</span></code>, see the <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/notebooks/casa-fundamentals.html#MeasurementSet-Basics">data description table</a> for more information. You could also try accessing the <code class="docutils literal notranslate"><span class="pre">DATA_DESCRIPTION</span></code> table directly by providing it as a subdirectory to the main table like so</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tb.open(fname + &quot;/DATA_DESCRIPTION&quot;)
SPECTRAL_WINDOW_ID = tb.getcol(&quot;SPECTRAL_WINDOW_ID&quot;)
tb.close()
print(SPECTRAL_WINDOW_ID)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0]
</pre></div>
</div>
</div>
</div>
</section>
<section id="how-many-channels-in-each-spw">
<h3>How many channels in each spw<a class="headerlink" href="#how-many-channels-in-each-spw" title="Permalink to this heading"></a></h3>
<p>Let’s figure out how many channels there are, and what their frequencies are (in Hz)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>spw_id = 0
msmd.open(fname)
chan_freq = msmd.chanfreqs(spw_id)
msmd.done()
nchan = len(chan_freq)
print(nchan)
print(chan_freq)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9
[2.30523958e+11 2.30524112e+11 2.30524266e+11 2.30524420e+11
 2.30524573e+11 2.30524727e+11 2.30524881e+11 2.30525035e+11
 2.30525189e+11]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-12-27 19:23:26	INFO	msmetadata_cmpt.cc::open	Performing internal consistency checks on logo_cube.noise.ms...
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-ms-tool-queries">
<h2>Example ms tool queries<a class="headerlink" href="#example-ms-tool-queries" title="Permalink to this heading"></a></h2>
<p>Sometimes your measurement set might contain multiple spectral windows with different numbers of channels or polarizations. In such a situation, the above queries with the <code class="docutils literal notranslate"><span class="pre">tb</span></code> tool will most likely fail, because they are trying to read data with inherently different shapes into an array with one common shape. One solution is to use the <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/global-tool-list/tool_ms/methods">ms</a> tool.</p>
<p>Two useful methods are <code class="docutils literal notranslate"><span class="pre">ms.selectinit</span></code> followed by <code class="docutils literal notranslate"><span class="pre">ms.getdata</span></code>. The first earmarks a subset of data based upon the given <code class="docutils literal notranslate"><span class="pre">DATA_DESC_ID</span></code>, the second returns the actual data from the columns specified. It is possible to retrieve the data from a single spectral window because all data within a given spectral window will have the same polarization and channelization setup. The downside is that if your dataset has multiple spectral windows, you will need to repeat the queries for each one. It isn’t obvious that there is a faster way to retrieve the data in such a situation, however.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ms.open(fname)
# select the spectral window
ms.selectinit(datadescid=0)
# query the desired columnames as a list
query = ms.getdata([&quot;WEIGHT&quot;, &quot;UVW&quot;])
# always a good idea to reset the earmarked data
ms.selectinit(reset=True)
ms.close()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># The returned query is a dictionary whose
# keys are the lowercase column names
print(query)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;uvw&#39;: array([[  105.98776896,    10.24073444,   -67.90482364, ...,
         2887.05933484,  1535.13378272, -1351.92555212],
       [   20.59023049,    36.16467912,   -58.30157267, ...,
         1007.13306603,  -340.05445448, -1347.18752051],
       [   47.86746886,    51.8762483 ,   -86.58515203, ...,
          730.95064349,  -862.07174858, -1593.02239207]]), &#39;weight&#39;: array([[1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.]])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># And the data values are the same as before
uvw = query[&quot;uvw&quot;]
print(uvw.shape)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(3, 325080)
</pre></div>
</div>
</div>
</div>
</section>
<section id="working-with-baselines">
<h2>Working with baselines<a class="headerlink" href="#working-with-baselines" title="Permalink to this heading"></a></h2>
<p>Baselines are stored in the <code class="docutils literal notranslate"><span class="pre">uvw</span></code> column, in units of meters.</p>
<section id="get-the-baselines">
<h3>Get the baselines<a class="headerlink" href="#get-the-baselines" title="Permalink to this heading"></a></h3>
<p>Read the baselines (in units of [m])</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>spw_id = 0
ms.open(fname)
ms.selectinit(spw_id)
d = ms.getdata([&quot;uvw&quot;])  
ms.done()
# d[&quot;uvw&quot;] is an array of float64 with shape [3, nvis]
uu, vv, ww = d[&quot;uvw&quot;]  # unpack into len nvis vectors
</pre></div>
</div>
</div>
</div>
<p>We can plot these up using matplotlib</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(nrows=1, figsize=(3.5, 3.5))
ax.scatter(uu, vv, s=1.5, rasterized=True, linewidths=0.0, c=&quot;k&quot;)
ax.set_xlabel(r&quot;$u$ [m]&quot;)
ax.set_ylabel(r&quot;$v$ [m]&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$v$ [m]&#39;)
</pre></div>
</div>
<img alt="../_images/fd5347efaee762261329208f2f07c8707bdebb7b761f3f423a4397fafa46ebad.png" src="../_images/fd5347efaee762261329208f2f07c8707bdebb7b761f3f423a4397fafa46ebad.png" />
</div>
</div>
</section>
<section id="convert-baselines-to-units-of-kilolambda">
<h3>Convert baselines to units of kilolambda<a class="headerlink" href="#convert-baselines-to-units-of-kilolambda" title="Permalink to this heading"></a></h3>
<p>To convert the baselines to units of kilolambda, we need to know the observing frequency (or wavelength). For a spectral window with multiple channels (like this one), the baselines (if expressed in units of kilolambda) will be slightly different for each channel because the observing frequency is different for each channel. Here is one way to go about broadcasting the baselines to all channels and then converting them to units of kilolambda.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># broadcast to the same shape as the data
# stub to broadcast uu,vv, and weights to all channels
broadcast = np.ones((nchan, 1))
uu = uu * broadcast
vv = vv * broadcast
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># calculate wavelengths for each channel, in meters
wavelengths = c.value / chan_freq[:, np.newaxis]  # m
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># convert baselines to klambda
uu = 1e-3 * uu / wavelengths  # [klambda]
vv = 1e-3 * vv / wavelengths  # [klambda]
</pre></div>
</div>
</div>
</div>
<p>Let’s plot up the baseline coverage for the first channel of the cube (index <code class="docutils literal notranslate"><span class="pre">0</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(nrows=1, figsize=(3.5, 3.5))
ax.scatter(uu[0], vv[0], s=1.5, rasterized=True, linewidths=0.0, c=&quot;k&quot;)
ax.set_xlabel(r&quot;$u$ [k$\lambda$]&quot;)
ax.set_ylabel(r&quot;$v$ [k$\lambda$]&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$v$ [k$\\lambda$]&#39;)
</pre></div>
</div>
<img alt="../_images/79d5b2ccdcb82045ef50a6cfaf827288bf1b03332c84ab6e311fa08070e81622.png" src="../_images/79d5b2ccdcb82045ef50a6cfaf827288bf1b03332c84ab6e311fa08070e81622.png" />
</div>
</div>
</section>
</section>
<section id="working-with-visibilities">
<h2>Working with visibilities<a class="headerlink" href="#working-with-visibilities" title="Permalink to this heading"></a></h2>
<section id="read-the-visibility-values-and-inspect-flags">
<h3>Read the visibility values and inspect flags<a class="headerlink" href="#read-the-visibility-values-and-inspect-flags" title="Permalink to this heading"></a></h3>
<p>Visibilities are stored in the main table of the measurement set. As long as all spectral windows have the same number of channels and polarizations, it should be possible to read visibilities using the table tool. If not, try the <code class="docutils literal notranslate"><span class="pre">ms</span></code> tool.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tb.open(fname)
weight = tb.getcol(&quot;WEIGHT&quot;)  # array of float64 with shape [npol, nvis]
flag = tb.getcol(&quot;FLAG&quot;)  # array of bool with shape [npol, nchan, nvis]
data_raw = tb.getcol(&quot;DATA&quot;)  # array of complex128 with shape [npol, nchan, nvis]
data_corrected = tb.getcol(
    &quot;CORRECTED_DATA&quot;
)  # array of complex128 with shape [npol, nchan, nvis]
tb.close()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Depending on how you’ve calibrated and/or split out your data, your measurement set may or may not have a <code class="docutils literal notranslate"><span class="pre">CORRECTED_DATA</span></code> column. Usually, this is the one you want. If the column doesn’t exist in your measurement set, try the <code class="docutils literal notranslate"><span class="pre">DATA</span></code> column instead.</p>
<p>For each visibility <span class="math notranslate nohighlight">\(i\)</span> there is also an accompanying <code class="docutils literal notranslate"><span class="pre">WEIGHT</span></code> <span class="math notranslate nohighlight">\(w_i\)</span>, which should correspond to the statistical uncertainty on the real and imaginary component of each visibility. Formally, the weight is defined as</p>
<div class="math notranslate nohighlight">
\[
w_i = \frac{1}{\sigma_i^2}
\]</div>
<p>and we expect that the noise is independent for each of the real and imaginary components of a visibility measurement. This means that we expect</p>
<div class="math notranslate nohighlight">
\[
\Re \{V_i\} = \Re\{\mathcal{V}\}_i + \epsilon_1
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\Im \{V_i\} = \Im\{\mathcal{V}\}_i + \epsilon_2
\]</div>
<p>where for each real and each imaginary component <span class="math notranslate nohighlight">\(\epsilon\)</span> is a new noise realization from a mean-zero Gaussian with standard deviation <span class="math notranslate nohighlight">\(\sigma_i\)</span>, i.e.,</p>
<div class="math notranslate nohighlight">
\[
\epsilon \sim \mathcal{N}\left ( 0, \sigma_i \right )
\]</div>
<p>CASA has a <a class="reference external" href="https://casa.nrao.edu/casadocs-devel/stable/calibration-and-visibility-data/data-weights">history</a> of different weight definitions, so this is definitely an important column to pay attention to, especially if your data was not acquired and processed in very recent cycles.</p>
<p>A common ALMA observation mode is dual-polarization, XX and YY. If this is the case for your observations, the data array will contain an extra dimension for each polarization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(data_corrected.shape)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 9, 325080)
</pre></div>
</div>
</div>
</div>
<p>Since it has a complex type, the data array contains the real and imaginary values</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(data_corrected.real)
print(data_corrected.imag)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[[-2.11916161 -0.15268645 -2.09786391 ... -2.13404036 -2.90118766
   -1.04123235]
  [ 1.53342223 -0.23143989  2.98143935 ... -0.94676274  2.0068481
   -0.11907034]
  [-0.79662246 -1.14639163  0.62018895 ...  0.24236043  0.29283872
    0.59977692]
  ...
  [-3.14505744  0.23288387 -1.28614867 ... -0.72165859 -1.80558801
    0.67348379]
  [ 1.32995152 -0.82827419  1.19441712 ...  2.12295151  0.56704634
    1.1603682 ]
  [ 1.44905758 -2.0859952   0.92960811 ...  0.80752301  1.82628858
   -0.09598707]]

 [[-0.03108021  3.73795938  2.53667879 ...  5.75586653  0.0541618
    0.34355548]
  [ 3.1469512   0.71387434  3.32055974 ...  0.3358534   0.84201574
   -3.85533071]
  [ 1.29277086  2.72364378 -0.55683601 ...  0.10498993 -2.5439899
   -0.55325317]
  ...
  [ 0.3654843   3.06427026 -0.3840104  ...  0.46281165  0.90841991
    0.15608166]
  [ 2.74898171  3.61377883  1.09398103 ...  1.70834064  0.86575133
   -0.79096657]
  [ 1.91854882 -1.39442146  1.24067175 ...  1.52981687  0.09519701
    0.0365302 ]]]
[[[-2.99232602 -0.30360636 -1.6191082  ...  1.66543949 -0.73851877
    0.43587497]
  [-1.92501354 -1.98033428 -1.61455917 ...  2.00273824 -1.60463917
    0.12746456]
  [ 2.01032281 -0.66581887 -1.73329353 ... -0.96323144 -2.43493104
   -3.50876737]
  ...
  [-2.97109795 -1.00361574  2.34259939 ... -0.97907937  0.9817946
    2.80909634]
  [ 1.69663787  3.62569261  0.49719986 ...  2.40872955 -0.6537838
   -0.3510958 ]
  [ 2.08565235  0.63548535 -0.18253912 ...  0.79163361  1.82951188
    3.57115531]]

 [[ 1.26486599  1.87651181 -2.76069164 ...  1.67063153  3.51279116
   -2.65790892]
  [-0.15228589  0.1893383   1.77173972 ...  4.28470659  1.41745424
    0.23584442]
  [-0.71109974  1.60024691  0.57425934 ... -0.00580254  0.86388081
   -1.27178192]
  ...
  [-0.25712714 -2.71436691  1.44051647 ...  1.40182054  0.11222342
   -0.36587125]
  [-3.32658386  2.07058764  1.06860614 ...  1.49408805 -0.42734656
    2.48918676]
  [ 3.17353868  2.24358296 -0.75121766 ... -2.13173437 -0.09157457
    1.6887821 ]]]
</pre></div>
</div>
</div>
</div>
<p>In the process of calibrating real-world data, some occasional visibilities need to be flagged or excluded from the analysis. The <code class="docutils literal notranslate"><span class="pre">FLAG</span></code> column is a boolean flag that is <code class="docutils literal notranslate"><span class="pre">True</span></code> if the visibility <em>should be excluded</em>. To check if any visibilities are flagged in this spectral window, we can just see if there are any <code class="docutils literal notranslate"><span class="pre">True</span></code> values in the <code class="docutils literal notranslate"><span class="pre">FLAG</span></code> column</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;Are there any flagged visibilities?&quot;, np.any(flag))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Are there any flagged visibilities? False
</pre></div>
</div>
</div>
</div>
<p>Since this is a simulated measurement set, this is not surprising. When you are using real data, however, this is an important thing to check. If you <em>did</em> have flagged visibilities, to access only the valid visibilities you would do something like the following</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data_good = data_corrected[~flag]
</pre></div>
</div>
</div>
</div>
<p>where the <code class="docutils literal notranslate"><span class="pre">~</span></code> operator helps us index only the visibilities which <em>are not flagged</em>. Unfortunately, indexing en masse like this removes any polarization and channelization dimensionality, just giving you a flat list</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(data_good.shape)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5851440,)
</pre></div>
</div>
</div>
</div>
<p>so you’ll need to be more strategic about this if you’d like to preserve the channel dimensions, perhaps by using a masked array or a ragged list.</p>
</section>
<section id="read-visibility-values-and-averaging-polarizations">
<h3>Read visibility values and averaging polarizations<a class="headerlink" href="#read-visibility-values-and-averaging-polarizations" title="Permalink to this heading"></a></h3>
<p>If your dataset is dual-polarization but you are not interested in treating the polarizations separately, it might be worth it to average the polarization channels together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tb.open(fname)
uvw = tb.getcol(&quot;UVW&quot;)  # array of float64 with shape [3, nvis]
weight = tb.getcol(&quot;WEIGHT&quot;)  # array of float64 with shape [npol, nvis]
flag = tb.getcol(&quot;FLAG&quot;)  # array of bool with shape [npol, nchan, nvis]
data = tb.getcol(&quot;CORRECTED_DATA&quot;)  # array of complex128 with shape [npol, nchan, nvis]
tb.close()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># average the polarizations
# https://en.wikipedia.org/wiki/Weighted_arithmetic_mean
data = np.sum(data * weight[:, np.newaxis, :], axis=0) / np.sum(weight, axis=0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># flag the data if either polarization was flagged
flag = np.any(flag, axis=0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># combine the weights across polarizations
weight = np.sum(weight, axis=0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Calculate the &quot;radial&quot; baseline
uu, vv, ww = uvw
qq = np.sqrt(uu ** 2 + vv ** 2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># calculate visibility amplitude and phase
amp = np.abs(data)
phase = np.angle(data)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Let&#39;s plot up the visibilities for the first channel
fig, ax = plt.subplots(nrows=1, figsize=(3.5, 3.5))
ax.scatter(qq, amp[0], s=1.5, rasterized=True, linewidths=0.0, c=&quot;k&quot;)
ax.set_xlabel(r&quot;$q$ [m]&quot;)
ax.set_ylabel(r&quot;Amplitude [Jy]&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Amplitude [Jy]&#39;)
</pre></div>
</div>
<img alt="../_images/d67232b62a1d31cff1f49d065f1f9439d8d28d58cbaf50da7f5cae1675b4522a.png" src="../_images/d67232b62a1d31cff1f49d065f1f9439d8d28d58cbaf50da7f5cae1675b4522a.png" />
</div>
</div>
</section>
</section>
<section id="exporting-visibilities">
<h2>Exporting visibilities<a class="headerlink" href="#exporting-visibilities" title="Permalink to this heading"></a></h2>
<p>This slightly larger example shows how to combine some of the above queries to read channel frequencies, baselines, and visibilites, and export them from the CASA environment saved as an <code class="docutils literal notranslate"><span class="pre">*.npz</span></code> file. We use the <code class="docutils literal notranslate"><span class="pre">table</span></code> tool here, but you could also use the <code class="docutils literal notranslate"><span class="pre">ms</span></code> tool.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># query the data
tb.open(fname)
ant1 = tb.getcol(&quot;ANTENNA1&quot;)  # array of int with shape [nvis]
ant2 = tb.getcol(&quot;ANTENNA2&quot;)  # array of int with shape [nvis]
uvw = tb.getcol(&quot;UVW&quot;)  # array of float64 with shape [3, nvis]
weight = tb.getcol(&quot;WEIGHT&quot;)  # array of float64 with shape [npol, nvis]
flag = tb.getcol(&quot;FLAG&quot;)  # array of bool with shape [npol, nchan, nvis]
data = tb.getcol(&quot;CORRECTED_DATA&quot;)  # array of complex128 with shape [npol, nchan, nvis]
tb.close()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># get the channel information
tb.open(fname + &quot;/SPECTRAL_WINDOW&quot;)
chan_freq = tb.getcol(&quot;CHAN_FREQ&quot;)
num_chan = tb.getcol(&quot;NUM_CHAN&quot;)
tb.close()
chan_freq = chan_freq.flatten()  # Hz
nchan = len(chan_freq)
</pre></div>
</div>
</div>
</div>
<p>Check to make sure the channels are in blushifted to redshifted order, otherwise reverse channel order</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>if (nchan &gt; 1) and (chan_freq[1] &gt; chan_freq[0]):
    # reverse channels
    chan_freq = chan_freq[::-1]
    data = data[:, ::-1, :]
    flag = flag[:, ::-1, :]
</pre></div>
</div>
</div>
</div>
<p>Keep only the cross-correlation visibilities and throw out the auto-correlation visibilities (i.e., where <code class="docutils literal notranslate"><span class="pre">ant1</span> <span class="pre">==</span> <span class="pre">ant2</span></code>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>xc = np.where(ant1 != ant2)[0]
data = data[:, :, xc]
flag = flag[:, :, xc]
uvw = uvw[:, xc]
weight = weight[:, xc]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># average the polarizations
data = np.sum(data * weight[:, np.newaxis, :], axis=0) / np.sum(weight, axis=0)
flag = np.any(flag, axis=0)
weight = np.sum(weight, axis=0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># After this step, ``data`` should be shape ``(nchan, nvis)`` and weights should be shape ``(nvis,)``
print(data.shape)
print(flag.shape)
print(weight.shape)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(9, 325080)
(9, 325080)
(325080,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># when indexed with mask, returns valid visibilities
mask = ~flag
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># convert uu and vv to kilolambda
uu, vv, ww = uvw  # unpack into len nvis vectors
# broadcast to the same shape as the data
# stub to broadcast uu,vv, and weights to all channels
broadcast = np.ones((nchan, 1))
uu = uu * broadcast
vv = vv * broadcast
weight = weight * broadcast
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># calculate wavelengths in meters
wavelengths = c.value / chan_freq[:, np.newaxis]  # m
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># calculate baselines in klambda
uu = 1e-3 * uu / wavelengths  # [klambda]
vv = 1e-3 * vv / wavelengths  # [klambda]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>frequencies = chan_freq * 1e-9  # [GHz]
</pre></div>
</div>
</div>
</div>
<p>Since we have a multi-channel dataset, we need to make a decision about how to treat flagged visibilities. If we wanted to export only unflagged visibilities, there is a chance that some channels will have different number of flagged visibilities, which means we can no longer represent the data as a nicely packed, contiguous, rectangular array.</p>
<p>Here, we sidestep this issue by just exporting <em>all</em> of the data (including flagged, potentially erroneous, visibilities), but, we also include the <code class="docutils literal notranslate"><span class="pre">mask</span></code> used to identify the valid visibilities. This punts on a final decision about how to store unflagged visibilities—the user will need to make sure that they correctly apply the mask when they load the data in a new environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># save data to numpy file for later use
np.savez(
    &quot;visibilities.npz&quot;,
    frequencies=frequencies,  # [GHz]
    uu=uu,  # [klambda]
    vv=vv,  # [klambda]
    weight=weight,  # [1/Jy^2]
    data=data,  # [Jy]
    mask=mask,  # [Bool]
)
</pre></div>
</div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../index.html" class="btn btn-neutral float-left" title="Visread documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="rescale_AS209_weights.html" class="btn btn-neutral float-right" title="Walkthrough: Examining DSHARP AS 209 Weights and Exporting Visibilities" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-23, Ian Czekala.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>